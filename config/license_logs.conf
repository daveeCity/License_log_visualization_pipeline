input {
  file {
    path => "/path/to/license/logs/*.log"
    start_position => "beginning"
    codec => plain
    sincedb_path => "/var/lib/logstash/plugins/inputs/file/.sincedb_license"
  }
}

filter {
  grok {
    match => {
      "message" => [
        # --- License events: Grant / Detachment / TimeOut ---
        "%{YEAR:year}/%{MONTHNUM:month}/%{MONTHDAY:day} %{TIME:time}:%{INT:ms}\s+%{WORD:log_level}\s+%{WORD:source}\s+(?<action>(Grant|Detachment|TimeOut)!!)!(?<product_code>[^!]+)!(?<license_id>[^!]+)!(?<license_name>[^!]+)!(?<license_type>[^!]+)!(?<license_count>[^!]+)!(?<license_mode>[^!]+)!(?<client_host>[^!]+) \(%{DATA:client_id}\)!%{IP:client_ip}!(?<user>[^!]+)!(?<user_full>[^!]+)!%{GREEDYDATA:process_path}!",

        # --- Denied license events (not granted) ---
        "%{YEAR:year}/%{MONTHNUM:month}/%{MONTHDAY:day} %{TIME:time}:%{INT:ms}\s+%{WORD:log_level}\s+LICENSESERV\s+(?<product_code>[A-Z0-9\-]+)\s+not granted,?\s*(user\s+(?<user>[^ ]+)\s+(?<reason>[^()]+))?\s*\( from client %{DATA:client_host} \(%{DATA:client_id}\)/%{IP:client_ip}\|%{DATA:user_info}\|%{DATA:user_full_info}\|%{GREEDYDATA:process_path}\)",

        # --- Startup / informational events ---
        "%{YEAR:year}/%{MONTHNUM:month}/%{MONTHDAY:day} %{TIME:time}:%{INT:ms}\s+%{WORD:log_level}\s+%{WORD:source}\s+%{GREEDYDATA:message}"
      ]
    }
  }

  mutate { lowercase => ["action"] }

  if "grant!!" in [action] {
    mutate { add_field => { "license_state" => "active" } }
  } else if "detachment!!" in [action] {
    mutate { add_field => { "license_state" => "detached" } }
  } else if "timeout!!" in [action] {
    mutate { add_field => { "license_state" => "expired" } }
  } else if "not granted" in [message] {
    mutate { add_field => { "license_state" => "denied" } }
  } else {
    mutate { add_field => { "license_state" => "other" } }
  }

  mutate {
    add_field => { "timestamp" => "%{year}/%{month}/%{day} %{time}:%{ms}" }
  }

  date {
    match => ["timestamp", "yyyy/MM/dd HH:mm:ss:SSS"]
    target => "@timestamp"
    timezone => "Europe/Rome"
  }

  mutate {
    remove_field => ["year", "month", "day", "time", "ms", "timestamp", "@version", "host", "path", "event"]
    add_field => { "source_system" => "License Server" }
  }

  fingerprint {
    source => ["message"]
    target => "[@metadata][fingerprint]"
    method => "SHA1"
  }
}

output {
  elasticsearch {
    hosts => ["https://<your-elasticsearch-host>:9200"]
    index => "license-logs-%{+YYYY.MM.dd}"
    document_id => "%{[@metadata][fingerprint]}"
    user => "<username>"
    password => "<password>"
    ssl_enabled => true
    ssl_verification_mode => none
  }

  stdout {
    codec => line {
      format => "[LOG] %{+YYYY-MM-dd HH:mm:ss} | %{action} | %{product_code} | %{user} | %{client_host}"
    }
  }
}
